name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 1'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: javascript-typescript
          build-mode: none
          queries-path: ./codeql/queries/javascript
        - language: java-kotlin
          build-mode: none
          queries-path: ./codeql/queries/java

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Verificar archivos Java antes del anÃ¡lisis
    - name: Verify Java files
      if: matrix.language == 'java-kotlin'
      run: |
        echo "=== ðŸ“ Archivos Java en el repositorio ==="
        find . -name "*.java" -type f
        echo ""
        echo "=== ðŸ“ Contenido de UnsafeExample.java ==="
        cat Java/src/main/java/com/example/UnsafeExample.java
        echo ""
        echo "=== ðŸ“ Contenido de SafeExample.java ==="
        cat Java/src/main/java/com/example/SafeExample.java
        echo ""
        echo "=== ðŸ” Contenido de la query personalizada ==="
        cat codeql/queries/java/UnsafeSqlConcat.ql

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: +${{ matrix.queries-path }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
        output: sarif-results
        upload: false

    # Inspeccionar resultados SARIF
    - name: Inspect SARIF Results
      if: matrix.language == 'java-kotlin'
      run: |
        echo "=== ðŸ” Buscando archivos SARIF ==="
        find . -name "*.sarif" -type f
        
        SARIF_FILE="sarif-results/java.sarif"
        
        if [ -f "$SARIF_FILE" ]; then
          echo ""
          echo "=== âœ… Archivo SARIF encontrado ==="
          
          echo ""
          echo "ðŸ“Š Total de alertas encontradas:"
          TOTAL=$(jq '.runs[].results | length' "$SARIF_FILE")
          echo "Total: $TOTAL"
          
          if [ "$TOTAL" -gt 0 ]; then
            echo ""
            echo "ðŸ“‹ Reglas que detectaron problemas:"
            jq -r '.runs[].results[].ruleId' "$SARIF_FILE" | sort | uniq -c
            
            echo ""
            echo "ðŸŽ¯ Detalles de java/sql-injection-concatenation:"
            jq '.runs[].results[] | select(.ruleId == "java/sql-injection-concatenation") | {ruleId, message: .message.text, location: .locations[0].physicalLocation.artifactLocation.uri}' "$SARIF_FILE" || echo "âŒ No se encontraron resultados para esta regla especÃ­fica"
            
            echo ""
            echo "ðŸ“„ TODAS las alertas encontradas:"
            jq -r '.runs[].results[] | "[\(.ruleId)] \(.message.text) - \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)"' "$SARIF_FILE"
          else
            echo ""
            echo "âš ï¸  No se encontraron alertas"
            echo ""
            echo "ðŸ” Verificando que la query se ejecutÃ³:"
            jq -r '.runs[].tool.driver.rules[] | select(.id == "java/sql-injection-concatenation") | {id, name, shortDescription}' "$SARIF_FILE" || echo "âŒ La query no aparece en las reglas ejecutadas"
          fi
          
        else
          echo ""
          echo "âŒ No se encontrÃ³ $SARIF_FILE"
          echo "Archivos SARIF encontrados:"
          find sarif-results -type f 2>/dev/null || echo "Directorio sarif-results no existe"
        fi

    # Guardar SARIF como artefacto para descarga
    - name: Upload SARIF as artifact
      if: matrix.language == 'java-kotlin'
      uses: actions/upload-artifact@v4
      with:
        name: codeql-sarif-java
        path: sarif-results/*.sarif
        if-no-files-found: warn

    # Subir a GitHub Security
    - name: Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: sarif-results
        category: "/language:${{matrix.language}}"
